编写一个详细且清晰的后端介绍文档是确保前端团队能够顺利接入后端服务、理解后端架构和数据库设计的关键。以下是一个详细的文档结构，包括如何帮助前端负责人理解后端服务的功能、如何接入前端，以及如何与数据库交互。

---

## **后端服务介绍文档**

### **1. 项目概述**

#### **项目背景**
我们正在开发一个基于大模型（如 Qwen-Plus）和智能手机控制系统的用户界面理解与交互系统。该系统通过云端大模型和本地 Android 设备的交互，实现自动化操作，如打开应用、发送按键事件等。系统还包括 OCR（光学字符识别）服务，以便处理用户上传的图片并提取其中的文字信息。

#### **后端功能**
后端主要负责以下任务：
- 与大模型的交互：根据用户输入和设备状态生成操作指令。
- 手机控制：通过 ADB 接口操控 Android 设备，执行相关操作。
- OCR 服务：处理图片并提取文字，供大模型分析。
- 任务管理与反馈：追踪任务进度，并记录任务执行的反馈。

---

### **2. 后端架构概述**

后端系统由多个模块组成，每个模块负责不同的功能。以下是模块的简要概述：

1. **API 网关 (`api_gateway`)**：
   - 负责接收前端请求，转发到后端服务。
   - 提供用户输入接口、任务状态反馈接口等。

2. **模型服务 (`model_service`)**：
   - 与云端大模型（如 Qwen-Plus）进行通信，根据用户请求和截图生成操作指令。
   - 需要传递用户输入和 OCR 识别的文本作为输入。

3. **OCR 服务 (`ocr_service`)**：
   - 通过调用 OCR 模型（如 Qwen-VL-OCR）识别图片中的文字，并返回识别结果。

4. **手机控制 (`phone_control`)**：
   - 使用 ADB 命令控制 Android 设备，实现模拟按键、滑动屏幕、输入文字等操作。

5. **任务管理 (`task_manager`)**：
   - 使用 Celery 处理异步任务，调度手机操作任务并跟踪任务状态。

6. **反馈服务 (`feedback`)**：
   - 记录任务的执行反馈，如操作成功或失败的状态，写入日志。

---

### **3. 服务接口文档**

#### **3.1 API 网关**

API 网关是前端与后端的交互入口。它负责转发用户的请求，协调后端服务的调用。

**端口**：`8000`

##### **接口1: `/user-input`**
- **方法**：`POST`
- **描述**：接收用户输入和截图信息，转发到大模型服务生成手机操作指令。
- **请求体**：
  ```json
  {
    "user_input": "打开微信",
    "image_url": "https://example.com/screenshot.jpg"
  }
  ```
- **响应**：
  ```json
  {
    "instructions": "点击微信图标"
  }
  ```

##### **接口2: `/task-status`**
- **方法**：`POST`
- **描述**：接收任务状态更新并反馈给任务管理系统。
- **请求体**：
  ```json
  {
    "task_id": "12345",
    "status": "completed",
    "details": "操作成功"
  }
  ```
- **响应**：
  ```json
  {
    "message": "Task status updated"
  }
  ```

---

#### **3.2 模型服务**

模型服务与大模型进行通信，根据输入生成操作指令。

**端口**：`8001`

##### **接口: `/process-request`**
- **方法**：`POST`
- **描述**：根据用户输入和截图信息生成手机操作指令。
- **请求体**：
  ```json
  {
    "user_input": "打开微信",
    "image_url": "https://example.com/screenshot.jpg"
  }
  ```
- **响应**：
  ```json
  {
    "instructions": "点击微信图标"
  }
  ```

---

#### **3.3 OCR 服务**

OCR 服务用于处理图像，提取其中的文字。

**端口**：`8006`

##### **接口: `/process-image`**
- **方法**：`POST`
- **描述**：接受图片 URL，返回图片中提取的文字。
- **请求体**：
  ```json
  {
    "image_url": "https://example.com/screenshot.jpg"
  }
  ```
- **响应**：
  ```json
  {
    "ocr_text": "这是微信的图标"
  }
  ```

---

#### **3.4 手机控制服务**

手机控制服务使用 ADB 接口控制 Android 设备。

**端口**：`8002`

##### **接口1: `/send-key-event`**
- **方法**：`POST`
- **描述**：模拟按键事件，如模拟点击电源键。
- **请求体**：
  ```json
  {
    "key_code": 26
  }
  ```
- **响应**：
  ```json
  {
    "message": "成功发送电源键事件"
  }
  ```

##### **接口2: `/swipe-screen`**
- **方法**：`POST`
- **描述**：模拟滑动屏幕。
- **请求体**：
  ```json
  {
    "x1": 100,
    "y1": 200,
    "x2": 300,
    "y2": 400,
    "duration": 500
  }
  ```
- **响应**：
  ```json
  {
    "message": "成功滑动屏幕"
  }
  ```

---

### **4. 数据库设计与接入**

我们使用 **Redis** 和 **MySQL** 来支持后端服务的持久化和缓存需求。

#### **4.1 Redis**
- 用于存储任务队列、缓存数据、会话信息等高频数据。
- 数据存储示例：
  - **任务队列**：使用 Redis 列表存储待处理任务。
  - **任务结果缓存**：使用 Redis 哈希表存储任务处理结果，并设置过期时间。

#### **4.2 MySQL**
- 用于长期存储任务历史记录、用户信息和操作日志。
- 数据表设计：
  - **任务表**：存储任务的详细信息，如任务 ID、状态、执行时间等。
  - **日志表**：记录操作日志，便于追踪和调试。

**示例表结构**：
```sql
CREATE TABLE tasks (
    task_id VARCHAR(36) PRIMARY KEY,
    user_input TEXT,
    status ENUM('pending', 'completed', 'failed'),
    result TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE logs (
    log_id INT AUTO_INCREMENT PRIMARY KEY,
    task_id VARCHAR(36),
    log_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

### **5. 接入说明**

#### **5.1 前端与后端的接入**
- **前端请求**：前端通过调用 `https://<your-backend-server>/user-input` 来提交用户输入，后端会返回大模型生成的手机操作指令。
- **前端展示**：前端可以根据后端返回的指令展示操作结果或触发相应的事件（如点击按钮、显示文本等）。

#### **5.2 与数据库的接入**
- 前端无需直接访问数据库。数据库的管理和任务数据的存储都由后端负责。通过访问 `task-status` 接口，前端可以获取任务的当前状态。
- 后端会根据用户输入和任务结果进行数据库操作。

---

### **6. 开发和测试环境**

#### **6.1 开发环境要求**
- Python 3.8+
- 安装依赖：
  ```bash
  pip install -r requirements.txt
  ```

#### **6.2 本地运行**
- 使用 `uvicorn` 启动服务：
  ```bash
  uvicorn run:app --host 0.0.0.0 --port 8000 --reload
  ```

#### **6.3 Docker 部署**
- 可以将后端服务容器化，便于部署到生产环境。请参考 `Dockerfile` 和 `docker-compose.yml`。

---

### **7. 总结与建议**

此文档介绍了后端架构和服务的功能及接入方式。前端团队可以通过 RESTful API 与后端交互，并通过数据库接口获取任务状态。为了简化前端接入，API 接口和返回数据格式保持一致且简洁。前端开发人员可以直接调用相应的 API 接口来实现与后端的交互，同时数据库的管理由后端负责，前端无需关心具体的数据库操作。
